{% extends 'tracker/base.html' %}
{% load sort_tags %}
{% block title %}Список трекеров{% endblock %}
{% block content %}
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Трекеры</h5>
    <a href="{% url 'tracker:tracker_create' %}" class="btn btn-success btn-sm float-end" role="button">Создать новый</a>
  </div>
  <div class="card-body p=0">
    <div class="table-responsive">
      <table class="table table-hover table-striped" id="tracker-table">
        <thead>
          <tr>
            <th class="sortable" aria-sort="{% aria_sort 'imei' %}"><a href="{% sort_url 'imei' %}" data-bs-toggle="tooltip" title="Сортировать по IMEI" aria-label="Сортировать по IMEI">IMEI{% sort_indicator 'imei' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'serial_number' %}"><a href="{% sort_url 'serial_number' %}" data-bs-toggle="tooltip" title="Сортировать по S/N трекера" aria-label="Сортировать по S/N трекера">S/N трекера{% sort_indicator 'serial_number' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'inventory_number_tracker' %}"><a href="{% sort_url 'inventory_number_tracker' %}" data-bs-toggle="tooltip" title="Сортировать по инвентарному номеру трекера" aria-label="Сортировать по инвентарному номеру трекера">Инвентарный номер трекера{% sort_indicator 'inventory_number_tracker' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'inventory_number_antenna' %}"><a href="{% sort_url 'inventory_number_antenna' %}" data-bs-toggle="tooltip" title="Сортировать по инвентарному номеру антенны" aria-label="Сортировать по инвентарному номеру антенны">Инвентарный номер антенны{% sort_indicator 'inventory_number_antenna' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'model' %}"><a href="{% sort_url 'model' %}" data-bs-toggle="tooltip" title="Сортировать по модели трекера" aria-label="Сортировать по модели трекера">Модель трекера{% sort_indicator 'model' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'protocol' %}"><a href="{% sort_url 'protocol' %}" data-bs-toggle="tooltip" title="Сортировать по протоколу" aria-label="Сортировать по протоколу">Протокол{% sort_indicator 'protocol' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'holder_number' %}"><a href="{% sort_url 'holder_number' %}" data-bs-toggle="tooltip" title="Сортировать по державному номеру" aria-label="Сортировать по державному номеру">Державний номер{% sort_indicator 'holder_number' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'location' %}"><a href="{% sort_url 'location' %}" data-bs-toggle="tooltip" title="Сортировать по локации" aria-label="Сортировать по локации">Локация{% sort_indicator 'location' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'sim_old' %}"><a href="{% sort_url 'sim_old' %}" data-bs-toggle="tooltip" title="Сортировать по старому SIM" aria-label="Сортировать по старому SIM">Старый SIM{% sort_indicator 'sim_old' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'n_card' %}"><a href="{% sort_url 'n_card' %}" data-bs-toggle="tooltip" title="Сортировать по N Card" aria-label="Сортировать по N Card">N Card{% sort_indicator 'n_card' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'sim_new' %}"><a href="{% sort_url 'sim_new' %}" data-bs-toggle="tooltip" title="Сортировать по новому SIM" aria-label="Сортировать по новому SIM">Новый SIM{% sort_indicator 'sim_new' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'comment' %}"><a href="{% sort_url 'comment' %}" data-bs-toggle="tooltip" title="Сортировать по комментарию" aria-label="Сортировать по комментарию">Комментарий{% sort_indicator 'comment' %}</a></th>
            <th class="sortable text-center" aria-sort="{% aria_sort 'is_active' %}"><a href="{% sort_url 'is_active' %}" data-bs-toggle="tooltip" title="Сортировать по активности" aria-label="Сортировать по активности">Активен{% sort_indicator 'is_active' %}</a></th>
          </tr>
        </thead>
        <tbody>
          {% for tracker in trackers %}
          <tr data-edit-url="{% url 'tracker:tracker_update' tracker.pk %}">
            <td>{{ tracker.imei }}</td>
            <td>{{ tracker.serial_number }}</td>
            <td>{{ tracker.inventory_number_tracker }}</td>
            <td>{{ tracker.inventory_number_antenna|default:"-" }}</td>
            <td>{{ tracker.model }}</td>
            <td>{{ tracker.get_protocol_display }}</td>
            <td>{{ tracker.holder_number|default:"-" }}</td>
            <td>{{ tracker.current_location|default:"-" }}</td>
            <td>{{ tracker.sim_old|default:"-" }}</td>
            <td>{{ tracker.n_card|default:"-" }}</td>
            <td>{{ tracker.sim_new|default:"-" }}</td>
            <td>{{ tracker.comment|default:"-" }}</td>
            <td class="text-center">
              {% if tracker.is_active %}
                <input type="checkbox" class="status-checkbox" disabled checked aria-checked="true" title="Активен" aria-label="Активен">
              {% else %}
                <span class="status-cross text-danger" role="img" aria-label="Не активен" title="Не активен">✖</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Модальное окно для редактирования -->
<div class="modal fade" id="editTrackerModal" tabindex="-1" aria-labelledby="editTrackerModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTrackerModalLabel">Редактировать трекер</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body" id="editTrackerModalBody">
        <div class="text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const table = document.getElementById('tracker-table');
  table.querySelectorAll('tbody tr').forEach(function(row) {
    row.addEventListener('dblclick', function() {
      const url = row.getAttribute('data-edit-url');
      const modal = new bootstrap.Modal(document.getElementById('editTrackerModal'));
      const modalBody = document.getElementById('editTrackerModalBody');
      modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
        .then(response => response.text())
        .then(html => {
          modalBody.innerHTML = html;
          const form = modalBody.querySelector('form');
          if (form) {
            function attachFormHandler(targetForm) {
              const handleSubmit = function(e) {
                e.preventDefault();
                const formData = new FormData(targetForm);
                fetch(url, {
                  method: 'POST',
                  headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                  },
                  body: formData,
                  credentials: 'same-origin'
                })
                .then(async response => {
                  console.log('Tracker form fetch status:', response.status);
                  const text = await response.text();
                  console.log('Tracker form fetch response:', text);
                  if (text.includes('<form')) {
                    modalBody.innerHTML = text;
                    const newForm = modalBody.querySelector('form');
                    if (newForm) attachFormHandler(newForm);
                  } else {
                    modal.hide();
                    window.location.reload();
                  }
                })
                .catch(err => console.error('Tracker form fetch error:', err));
              };
              targetForm.addEventListener('submit', handleSubmit);
            }
            attachFormHandler(form);
          }
        });
      modal.show();
    });
  });
});
</script>
{% endblock %}
