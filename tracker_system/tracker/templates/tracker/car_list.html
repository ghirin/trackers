{% extends 'tracker/base.html' %}
{% load sort_tags %}
{% block title %}Список автомобилей{% endblock %}
{% block content %}
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">Автомобили</h5>
    <a href="{% url 'tracker:car_create' %}" class="btn btn-success btn-sm float-end" role="button"><i class="fa fa-plus me-1" aria-hidden="true"></i>Создать новый элемент</a>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover table-striped">
        <thead>
          <tr>
            <th class="sortable" aria-sort="{% aria_sort 'state_number' %}"><a href="{% sort_url 'state_number' %}">Державний номер{% sort_indicator 'state_number' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'board_number' %}"><a href="{% sort_url 'board_number' %}">Бортовой номер{% sort_indicator 'board_number' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'model' %}"><a href="{% sort_url 'model' %}">Модель{% sort_indicator 'model' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'location' %}"><a href="{% sort_url 'location' %}">Локация{% sort_indicator 'location' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'is_active' %}"><a href="{% sort_url 'is_active' %}">Статус{% sort_indicator 'is_active' %}</a></th>
            <th class="sortable" aria-sort="{% aria_sort 'comment' %}"><a href="{% sort_url 'comment' %}">Комментарий{% sort_indicator 'comment' %}</a></th>
          </tr>
        </thead>
        <tbody>
          {% for car in cars %}
          <tr>
            <td><a href="{% url 'tracker:car_detail' car.pk %}">{{ car.state_number }}</a></td>
            <td>{{ car.board_number|default:"-" }}</td>
            <td>{{ car.get_model_display }}</td>
            <td>{{ car.location|default:"-" }}</td>
            <td>{% if car.is_active %}<span class="badge-yes">Активен</span>{% else %}<span class="badge bg-danger">Неактивен</span>{% endif %}</td>
            <td>{{ car.comment|default:"-" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% include 'tracker/includes/pagination.html' %}
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const table = document.querySelector('table.table-hover');
  table.querySelectorAll('tbody tr').forEach(function(row) {
    row.addEventListener('dblclick', function() {
      const pk = row.querySelector('a').getAttribute('href').split('/').filter(Boolean).pop();
      const url = `/tracker/cars/${pk}/update/`;
      const modal = new bootstrap.Modal(document.getElementById('editCarModal'));
      const modalBody = document.getElementById('editCarModalBody');
      modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Загрузка...</span></div></div>';
      fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, credentials: 'same-origin' })
        .then(response => response.text())
        .then(html => {
          modalBody.innerHTML = html;
          // Добавляем обработчик submit для формы в модалке
          const form = modalBody.querySelector('form');
          if (form) {
            form.addEventListener('submit', function(e) {
              e.preventDefault();
              const formData = new FormData(form);
              fetch(url, {
                method: 'POST',
                headers: {
                  'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData,
                credentials: 'same-origin'
              })
              .then(async response => {
                const text = await response.text();
                console.log('Car form fetch status:', response.status);
                console.log('Car form fetch response:', text);
                // Если в ответе снова форма — показать ошибки, иначе закрыть модалку и обновить страницу
                if (text.includes('<form')) {
                  modalBody.innerHTML = text;
                  // Повторно навешиваем обработчик submit на новую форму
                  const newForm = modalBody.querySelector('form');
                  if (newForm) {
                    newForm.addEventListener('submit', arguments.callee);
                  }
                } else {
                  modal.hide();
                  window.location.reload();
                }
              });
            });
          }
        });
      modal.show();
    });
  });
});
</script>
<div class="modal fade" id="editCarModal" tabindex="-1" aria-labelledby="editCarModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCarModalLabel">Редактировать автомобиль</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body" id="editCarModalBody">
        <div class="text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Загрузка...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
