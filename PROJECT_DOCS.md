# Документация по работе с проектом Trackers

> Краткое руководство по установке, запуску, работе с элементами и поддержке системы.

---

## Содержание
- [Краткое описание](#краткое-описание)
- [Требования](#требования)
- [Быстрая установка](#быстрая-установка)
- [База данных и миграции](#база-данных-и-миграции)
- [Запуск сервера](#запуск-сервера)
- [Тестирование](#тестирование)
- [Команды управления (management commands)](#команды-управления-management-commands)
- [Структура основных сущностей](#структура-основных-сущностей)
- [Работа через UI](#работа-через-ui)
- [Экспорт XLSX](#экспорт-xlsx)
- [Доступность и UX](#доступность-и-ux)
- [Полезные советы и отладка](#полезные-советы-и-отладка)
- [Вклад и правки](#вклад-и-правки)

---

## Краткое описание
Проект — учёт и управление трекерами, автомобилями и историей их установок.
Включает веб-интерфейс (Django) с административной панелью, сортируемыми таблицами, экспортом в XLSX, формами создания/изменения и набором тестов.

## Требования
- Python 3.10+ (в проекте использовалась 3.12)
- Django 4.x/6.x (см. `requirements.txt`)
- Доп. зависимости: `openpyxl`, `django-import-export` и другие из `requirements.txt`.

## Быстрая установка
1. Склонируйте репозиторий и перейдите в корень проекта:

```bash
cd /path/to/trackers
```

2. Создайте и активируйте виртуальное окружение:

```bash
python -m venv venv
source venv/bin/activate
```

3. Установите зависимости:

```bash
pip install -r requirements.txt
```

4. Создайте файл настроек окружения (если нужно) и примените миграции (см. раздел ниже).

## База данных и миграции
- Миграции хранятся в `tracker/migrations/`.
- Применение миграций:

```bash
python tracker_system/manage.py migrate
```

- Важно: в рабочей истории присутствует миграция `0008_add_order_document_to_installation` — убедитесь, что она применена на целевом окружении.

- Создание суперпользователя для доступа в админку:

```bash
python tracker_system/manage.py createsuperuser
```

## Запуск сервера
Запуск в режиме разработки:

```bash
python tracker_system/manage.py runserver
```

Откройте приложение: http://127.0.0.1:8000/

## Тестирование
Запуск всех тестов:

```bash
python tracker_system/manage.py test
```

Запуск отдельного набора тестов, например UI:

```bash
python tracker_system/manage.py test tracker.tests.test_ui_buttons
```

## Команды управления (management commands)
- `backup_system` — создание/выгрузка резервной копии (см. `tracker/management/commands/backup_system.py`).
- `restore_system` — восстановление из резервной копии (см. `tracker/management/commands/restore_system.py`).

Запуск:

```bash
python tracker_system/manage.py backup_system
python tracker_system/manage.py restore_system <backupfile>
```

## Структура основных сущностей
- Car — автомобили (поля: board_number, state_number, model, location, comment, is_active и пр.).
- Tracker — оборудование (imei, serial_number, inventory numbers, protocol, SIM-поля, comment, is_active). Имеет свойство `current_location` (последняя активная установка).
- InstallationHistory — история установок (FK на Car, Tracker, опциональный `order_document`, даты установки/снятия, комментарий, is_active).
- OrderDocument — документы/приказы (доступны через админку). InstallationHistory имеет FK на OrderDocument.

## Работа через UI
- Страницы:
  - `/tracker/` — дашборд
  - `/tracker/cars/` — список автомобилей
  - `/tracker/trackers/` — список трекеров
  - `/tracker/installations/` — история установок
  - `/tracker/reports/` — отчёты и экспорт
- На страницах списков реализована серверная сортировка: клик по заголовку таблицы добавляет параметр `?sort=<поле>` (реализовано через templatetags `sort_tags.py`).
- Кнопки создания доступны на страницах списков (напр., "Создать новый элемент"); при отсутствии заказов на странице установок отображается предупреждение с ссылкой на создание приказа в админке.
- Редактирование элементов доступно через модальные формы (двойной клик по строке) и обычную форму при создании/редактировании.

## Экспорт XLSX
- Экспорт реализован с помощью `openpyxl`. Файл создаётся на лету и предлагается пользователю.
- Экспорт включает отдельные колонки для бортового (`board_number`) и державного (`state_number`) номеров, и применяет зебра-стиль (Striped rows).

## Доступность и UX
- Табличные заголовки содержат `aria-sort` и подсказки (Bootstrap tooltips).
- Комментарии с длинным текстом обрезаются с `text-overflow` и показывают полный текст в tooltip.
- Статус активности отображается как чекбокс (для активных) или крест (для неактивных). Кнопки и предупреждения оптимизированы для контраста.

## Полезные советы и отладка
- Если тесты падают с ошибкой ModuleNotFoundError: проверьте установку зависимостей (`pip install -r requirements.txt`). В прошлом встречалась необходимость установить `django-import-export`.
- Избегайте обращения к внутренним атрибутам объектов (напр. `__class__.__name__`) в шаблонах — это вызывало TemplateSyntaxError. Рендерьте поля напрямую `{{ field }}` или добавляйте вспомогательные свойства в форму/view.
- Если после применения миграций появляются конфликты в БД, проверьте последовательность миграций и при необходимости пересоздайте тестовую БД.

## Внесение изменений и тесты
- Добавляйте тесты для новой функциональности в `tracker/tests/`.
- Запускайте тесты локально перед пушем.
- Следуйте уже принятому стилю: templatetags для общих шаблонных хелперов, серверная safelist сортировка в views (возможные поля явно перечислены в `allowed`).

## Полезные файлы и места в проекте
- Основные модели: `tracker/models.py`
- Формы: `tracker/forms.py`
- Вьюхи: `tracker/views.py`
- Шаблоны: `tracker/templates/tracker/` (списки: `*_list.html`, формы: `*_form.html`, включения: `includes/`)
- Темплатетеги сортировки: `tracker/templatetags/sort_tags.py`
- Тесты: `tracker/tests/`
- Миграции: `tracker/migrations/`

---

Если нужно, могу расширить этот документ:
- добавить подробную инструкцию по деплою (Gunicorn/Nginx, env vars),
- описать формат экспорта и пример обработки XLSX, или
- добавить секцию для CI/CD (github actions) и проверки качества кода.

---

Автор: Yury Ghirin
Дата: 2026-02-04

Визуальные схемы данных:

Для создания схем данных нам необходимо:

1. Установить в систему grafviz и другие библиотеки:

sudo apt install graphviz libgraphviz-dev graphviz-dev pkg-config
2. В окружении проекта установить приложения django-extensions и pygrafviz
pip install pygraphviz
pip install django-extensions
3. В настройках проекта settings.py добавить приложение django-extensions 
INSTALLED_APPS = (
    ...
    'django_extensions',
)

4. Если в проекте используются сторонние шаблонизаторы, то для создания схемы их необходимо временно отключить так как django-extensions использует родные шаблоны Django.

5. Ну и наконец для создания схемы моделей используем команды:
# Для всего проекта
./manage.py graph_models -a -g -o my_project_visualized.png
# Для отдельных приложений проекта
./manage.py graph_models django_app -g -o ../django_app_models.png